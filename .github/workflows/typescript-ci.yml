name: TypeScript CI

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: typescript/package-lock.json
    
    - name: Install dependencies
      working-directory: ./typescript
      run: npm ci
    
    - name: Build
      working-directory: ./typescript
      run: npm run build
    
    - name: Run tests
      working-directory: ./typescript
      run: npm test

  publish-plugin:
    name: Publish to Plugins Marketplace
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout source repo
      uses: actions/checkout@v4
      with:
        path: source

    - name: Checkout plugins repo
      uses: actions/checkout@v4
      with:
        repository: spec-works/plugins
        token: ${{ secrets.PLUGINS_REPO_TOKEN }}
        path: plugins

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Publish plugin
      run: |
        PLUGIN_NAME="xregistry-mcp"
        SKILL_NAME="xregistry-mcp"
        VERSION="${{ steps.version.outputs.VERSION }}"

        # Copy skills
        mkdir -p plugins/plugins/${PLUGIN_NAME}/skills/${SKILL_NAME}
        if [ -d "source/skills/${SKILL_NAME}" ]; then
          cp -r source/skills/${SKILL_NAME}/* plugins/plugins/${PLUGIN_NAME}/skills/${SKILL_NAME}/
        fi

        # Copy .mcp.json (this is an MCP server plugin)
        if [ -f "source/.mcp.json" ]; then
          cp source/.mcp.json plugins/plugins/${PLUGIN_NAME}/.mcp.json
        fi

        # Update marketplace.json
        cd plugins
        cat .github/plugin/marketplace.json | \
          jq --arg name "$PLUGIN_NAME" --arg version "$VERSION" \
          '(.plugins[] | select(.name == $name)).version = $version' \
          > .github/plugin/marketplace.json.tmp
        mv .github/plugin/marketplace.json.tmp .github/plugin/marketplace.json

    - name: Commit and push
      working-directory: plugins
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git diff --cached --quiet && echo "No changes to publish" && exit 0
        git commit -m "Publish xregistry-mcp plugin v${{ steps.version.outputs.VERSION }}"
        git push
